// js/main.js - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ  Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Bein Sport...');
    new BeinSportApp();
});

class BeinSportApp {
    constructor() {
        this.sections = [];
        this.channels = [];
        this.init();
    }

    async init() {
        console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        this.showLoading();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await this.loadData();
    }

    async loadData() {
        console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        try {
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Firebase
            const firebaseLoaded = await this.tryLoadFromFirebase();
            if (firebaseLoaded) return;
            
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: localStorage
            const localLoaded = await this.tryLoadFromLocalStorage();
            if (localLoaded) return;
            
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            this.loadDefaultData();
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
            this.loadDefaultData();
        }
    }

    async tryLoadFromFirebase() {
        try {
            console.log('ğŸ“¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase...');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Firebase SDK
            if (typeof firebase === 'undefined') {
                console.warn('âš ï¸ Firebase SDK ØºÙŠØ± Ù…Ø­Ù…Ù„');
                return false;
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… firebaseUtils
            await firebaseUtils.initializeFirebase();
            console.log('âœ… Firebase Ù…Ù‡ÙŠØ£ Ø¨Ù†Ø¬Ø§Ø­');
            
            const db = firebaseUtils.getDB();
            if (!db) {
                console.warn('âš ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                return false;
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const sectionsSnapshot = await db.collection('sections').get();
            if (sectionsSnapshot.empty) {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Firebase');
                return false;
            }
            
            this.sections = sectionsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${this.sections.length} Ù‚Ø³Ù… Ù…Ù† Firebase`);
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
            const channelsSnapshot = await db.collection('channels').get();
            if (!channelsSnapshot.empty) {
                this.channels = channelsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${this.channels.length} Ù‚Ù†Ø§Ø© Ù…Ù† Firebase`);
            }
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            this.saveToLocalStorage();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            this.renderSections();
            this.showSuccessMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            
            return true;
            
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Firebase:', error.message);
            return false;
        }
    }

    async tryLoadFromLocalStorage() {
        try {
            console.log('ğŸ’¾ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...');
            
            const savedSections = localStorage.getItem('bein_sections');
            const savedChannels = localStorage.getItem('bein_channels');
            
            if (!savedSections) {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©');
                return false;
            }
            
            this.sections = JSON.parse(savedSections);
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${this.sections.length} Ù‚Ø³Ù… Ù…Ù† localStorage`);
            
            if (savedChannels) {
                this.channels = JSON.parse(savedChannels);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${this.channels.length} Ù‚Ù†Ø§Ø© Ù…Ù† localStorage`);
            }
            
            this.renderSections();
            this.showInfoMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            
            return true;
            
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ localStorage:', error.message);
            return false;
        }
    }

    loadDefaultData() {
        console.log('ğŸ“‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
        
        this.sections = [
            {
                id: '1',
                name: 'Ù‚Ù†ÙˆØ§Øª Ø¨ÙŠ Ø¥Ù† Ø³Ø¨ÙˆØ±Øª',
                order: 1,
                isActive: true,
                description: 'Ø¬Ù…ÙŠØ¹ Ù‚Ù†ÙˆØ§Øª Ø¨ÙŠ Ø¥Ù† Ø³Ø¨ÙˆØ±Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©',
                image: 'https://via.placeholder.com/300x200/2F2562/FFFFFF?text=BEIN+SPORT'
            },
            {
                id: '2',
                name: 'Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©',
                order: 2,
                isActive: true,
                description: 'Ø£ÙØ¶Ù„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©',
                image: 'https://via.placeholder.com/300x200/2F2562/FFFFFF?text=SPORTS'
            },
            {
                id: '3',
                name: 'Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                order: 3,
                isActive: true,
                description: 'Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø©',
                image: 'https://via.placeholder.com/300x200/2F2562/FFFFFF?text=ARABIC'
            },
            {
                id: '4',
                name: 'Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ±ÙÙŠÙ‡',
                order: 4,
                isActive: true,
                description: 'Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø£ÙÙ„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª',
                image: 'https://via.placeholder.com/300x200/2F2562/FFFFFF?text=ENTERTAIN'
            }
        ];
        
        this.channels = [
            {
                id: '1',
                name: 'Ø¨ÙŠ Ø¥Ù† Ø³Ø¨ÙˆØ±Øª 1',
                image: 'https://via.placeholder.com/200x100/2F2562/FFFFFF?text=BEIN+1',
                url: '#',
                order: 1,
                sectionId: '1',
                appUrl: 'https://play.google.com/store/apps/details?id=com.xpola.player'
            },
            {
                id: '2',
                name: 'Ø¨ÙŠ Ø¥Ù† Ø³Ø¨ÙˆØ±Øª 2',
                image: 'https://via.placeholder.com/200x100/2F2562/FFFFFF?text=BEIN+2',
                url: '#',
                order: 2,
                sectionId: '1',
                appUrl: 'https://play.google.com/store/apps/details?id=com.xpola.player'
            },
            {
                id: '3',
                name: 'Ø¨ÙŠ Ø¥Ù† Ø³Ø¨ÙˆØ±Øª 3',
                image: 'https://via.placeholder.com/200x100/2F2562/FFFFFF?text=BEIN+3',
                url: '#',
                order: 3,
                sectionId: '1',
                appUrl: 'https://play.google.com/store/apps/details?id=com.xpola.player'
            }
        ];
        
        this.saveToLocalStorage();
        this.renderSections();
        this.showWarningMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
    }

    showLoading() {
        const container = document.getElementById('sectionsContainer');
        if (container) {
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</p>
                    <small>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</small>
                </div>
            `;
        }
    }

    renderSections() {
        const container = document.getElementById('sectionsContainer');
        if (!container) {
            console.error('âŒ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§
        const activeSections = this.sections
            .filter(section => section.isActive !== false)
            .sort((a, b) => (a.order || 1) - (b.order || 1));
        
        if (activeSections.length === 0) {
            container.innerHTML = `
                <div class="loading">
                    <i class="uil uil-folder" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    <small>Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹</small>
                </div>
            `;
            return;
        }

        console.log(`ğŸ¯ Ø¹Ø±Ø¶ ${activeSections.length} Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©`);
        
        container.innerHTML = activeSections.map(section => {
            const channelCount = this.channels.filter(channel => channel.sectionId === section.id).length;
            const sectionLink = `section.html?id=${section.id}`;
            
            return `
                <a href="${sectionLink}" class="section-card" data-section-id="${section.id}">
                    <div class="section-card-link">
                        ${section.image ? `
                            <div class="section-image">
                                <img src="${section.image}" alt="${section.name}" 
                                     onerror="this.src='https://via.placeholder.com/300x200/2F2562/FFFFFF?text=IMG'">
                            </div>
                        ` : `
                            <div class="section-icon">
                                <i class="uil uil-folder"></i>
                            </div>
                        `}
                        <div class="section-name">${section.name}</div>
                        ${section.description ? `<div class="section-description-card">${section.description}</div>` : ''}
                        <div class="section-badge">${channelCount} Ù‚Ù†Ø§Ø©</div>
                    </div>
                </a>
            `;
        }).join('');

        console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem('bein_sections', JSON.stringify(this.sections));
            localStorage.setItem('bein_channels', JSON.stringify(this.channels));
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        }
    }

    showSuccessMessage(message) {
        this.showMessage(message, 'success', 'uil-check-circle');
    }

    showInfoMessage(message) {
        this.showMessage(message, 'info', 'uil-info-circle');
    }

    showWarningMessage(message) {
        this.showMessage(message, 'warning', 'uil-exclamation-triangle');
    }

    showMessage(message, type, icon) {
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
        const oldAlerts = document.querySelectorAll('.custom-alert');
        oldAlerts.forEach(alert => alert.remove());
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const alertDiv = document.createElement('div');
        alertDiv.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="uil ${icon} me-2"></i> ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        const content = document.querySelector('.content');
        if (content) {
            content.insertBefore(alertDiv, content.firstChild);
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    retryLoadData() {
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        this.showLoading();
        setTimeout(() => this.loadData(), 500);
    }
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.reloadAppData = function() {
    if (window.app) {
        window.app.retryLoadData();
    }
};

// Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ app Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ØŒ Ù†Ù†Ø´Ø¦Ù‡
if (!window.app) {
    window.app = new BeinSportApp();
}
