<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تشخيص نظام الإشعارات</title>
</head>
<body>
    <h1>تشخيص نظام الإشعارات</h1>
    
    <button onclick="runDiagnostics()">بدء التشخيص</button>
    
    <div id="results" style="margin-top: 20px;"></div>
    
    <script>
        async function runDiagnostics() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>جاري التشخيص...</h3>';
            
            let logs = [];
            
            // 1. التحقق من الصفحة
            logs.push(`✅ الصفحة: ${window.location.href}`);
            
            // 2. التحقق من Firebase SDK
            if (typeof firebase === 'undefined') {
                logs.push('❌ Firebase SDK غير محمل');
            } else {
                logs.push('✅ Firebase SDK محمل');
            }
            
            // 3. التحقق من firebaseUtils
            if (typeof firebaseUtils === 'undefined') {
                logs.push('❌ firebaseUtils غير محمل');
            } else {
                logs.push('✅ firebaseUtils محمل');
            }
            
            // 4. التحقق من notificationSystem
            if (typeof notificationSystem === 'undefined') {
                logs.push('❌ notificationSystem غير محمل');
            } else {
                logs.push('✅ notificationSystem محمل');
                
                // التحقق من حالة النظام
                logs.push(`- firestoreAvailable: ${notificationSystem.firestoreAvailable}`);
                logs.push(`- عدد الإشعارات: ${notificationSystem.notifications ? notificationSystem.notifications.length : 0}`);
            }
            
            // 5. التحقق من localStorage
            const storedNotifications = localStorage.getItem('bein_notifications');
            if (!storedNotifications) {
                logs.push('⚠️ لا توجد إشعارات في localStorage');
            } else {
                const notifications = JSON.parse(storedNotifications);
                logs.push(`✅ يوجد ${notifications.length} إشعار في localStorage`);
            }
            
            // 6. التحقق من زر الإشعارات في الهيدر
            const notificationBtn = document.querySelector('.notification-btn');
            if (!notificationBtn) {
                logs.push('❌ زر الإشعارات غير موجود في الهيدر');
            } else {
                logs.push('✅ زر الإشعارات موجود في الهيدر');
            }
            
            // 7. محاولة جلب الإشعارات من Firebase مباشرة
            if (typeof firebaseUtils !== 'undefined') {
                try {
                    await firebaseUtils.initializeFirebase();
                    const db = firebaseUtils.getDB();
                    const snapshot = await db.collection('notifications')
                        .where('isActive', '==', true)
                        .limit(5)
                        .get();
                    
                    logs.push(`✅ يوجد ${snapshot.size} إشعار نشط في Firebase`);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        logs.push(`- "${data.title}" (${new Date(data.createdAt).toLocaleString()})`);
                    });
                } catch (error) {
                    logs.push(`❌ خطأ في جلب الإشعارات من Firebase: ${error.message}`);
                }
            }
            
            // عرض النتائج
            results.innerHTML = '<h3>نتائج التشخيص:</h3>' + 
                logs.map(log => `<p>${log}</p>`).join('');
        }
        
        // تحميل الملفات المطلوبة
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // تحميل الملفات عند فتح الصفحة
        window.addEventListener('load', async () => {
            try {
                await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');
                await loadScript('js/firebase-config.js');
                await loadScript('js/notifications.js');
                
                console.log('✅ جميع الملفات محملة');
            } catch (error) {
                console.error('❌ خطأ في تحميل الملفات:', error);
            }
        });
    </script>
</body>
</html>
