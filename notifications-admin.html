<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - ÙˆØ³ÙŠÙ„ Ù„Ø§ÙŠÙ Ø¨Ø±Ùˆ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/notifications.css">
    <style>
        .notification-item-admin {
            background: linear-gradient(135deg, #2F2562, #3A4266);
            border-radius: 10px;
            border: 1px solid #42318F;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .notification-item-admin.active {
            border-left: 4px solid #28a745;
        }
        
        .notification-item-admin.inactive {
            border-left: 4px solid #6c757d;
        }
        
        .notification-item-admin.selected {
            background: linear-gradient(135deg, #322769, #654FD4);
            border: 2px solid #FF5200;
        }
        
        .notification-item-admin:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .notification-checkbox {
            margin-top: 10px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #bd2130);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
            border: none;
        }
        
        .btn-success:hover {
            background: linear-gradient(45deg, #218838, #1e7e34);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 style="color: #E1E1E1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 2.5rem;">
                        <i class="uil uil-bell"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    </h1>
                    <p class="text-muted">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ø§</p>
                </div>

                <!-- Add Notification Form -->
                <div class="card mb-5" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-plus-circle"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="notificationForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± *</label>
                                        <input type="text" id="notificationTitle" class="form-control" required 
                                               placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
                                        <select id="notificationType" class="form-control">
                                            <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                                            <option value="warning">ØªØ­Ø°ÙŠØ±</option>
                                            <option value="success">Ù†Ø¬Ø§Ø­</option>
                                            <option value="update">ØªØ­Ø¯ÙŠØ«</option>
                                            <option value="promotion">Ø¹Ø±Ø¶ ØªØ±ÙˆÙŠØ¬ÙŠ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                        <input type="text" id="notificationActionUrl" class="form-control" 
                                               placeholder="https://example.com">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                        <input type="date" id="notificationExpiry" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± *</label>
                                <textarea id="notificationMessage" class="form-control" rows="4" required 
                                          placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±..."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="sendImmediately" checked>
                                        <label class="form-check-label">
                                            Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="isImportant">
                                        <label class="form-check-label">
                                            Ø¥Ø´Ø¹Ø§Ø± Ù…Ù‡Ù…
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="showAsPopup" checked>
                                        <label class="form-check-label">
                                            Ø¹Ø±Ø¶ ÙƒÙ†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success flex-fill py-3" onclick="sendNotification()">
                                    <i class="uil uil-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testPopup()">
                                    <i class="uil uil-window"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
                                </button>
                                <a href="admin.html" class="btn btn-secondary">
                                    <i class="uil uil-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="card mb-4" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-trash-alt"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-danger w-100 mb-2" onclick="deleteAllNotifications()">
                                    <i class="uil uil-trash-alt"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙ„
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100 mb-2" onclick="deleteExpiredNotifications()">
                                    <i class="uil uil-clock"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100 mb-2" onclick="markAllAsRead()">
                                    <i class="uil uil-check-circle"></i> ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="refreshNotifications()">
                                    <i class="uil uil-refresh"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="card" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-list-ui-alt"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
                            <span id="notificationsCount" class="badge bg-primary ms-2">0</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="notificationsSearch" class="form-control" 
                                           placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª..." oninput="filterNotifications()">
                                </div>
                                <div class="col-md-3">
                                    <select id="notificationsFilter" class="form-control" onchange="filterNotifications()">
                                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                                        <option value="active">Ù†Ø´Ø·Ø©</option>
                                        <option value="popup">Ù…Ù†Ø¨Ø«Ù‚Ø©</option>
                                        <option value="important">Ù…Ù‡Ù…Ø©</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-info w-100" onclick="exportNotifications()">
                                        <i class="uil uil-import"></i> ØªØµØ¯ÙŠØ±
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="notificationsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                                </div>
                                <p class="mt-3 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script>
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        let db = null;
        
        async function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK ØºÙŠØ± Ù…Ø­Ù…Ù„');
                }
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAkgEiYYlmpMe0NLewulheovlTQMz5C980",
                    authDomain: "bein-42f9e.firebaseapp.com",
                    projectId: "bein-42f9e",
                    storageBucket: "bein-42f9e.firebasestorage.app",
                    messagingSenderId: "143741167050",
                    appId: "1:143741167050:web:922d3a0cddb40f67b21b33",
                    measurementId: "G-JH198SKCFS"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                return true;
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
                showAlert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                return false;
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        let notifications = [];
        
        async function loadNotifications() {
            try {
                if (!db) {
                    await initializeFirebase();
                }
                
                const snapshot = await db.collection('notifications')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                if (snapshot.empty) {
                    notifications = [];
                    renderNotifications();
                    return;
                }
                
                notifications = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderNotifications();
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'error');
            }
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            const countElement = document.getElementById('notificationsCount');
            
            if (!container) return;
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="uil uil-bell-slash" style="font-size: 80px; color: #6c757d;"></i>
                        <h5 class="mt-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h5>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
            const searchTerm = document.getElementById('notificationsSearch').value.toLowerCase();
            const filterType = document.getElementById('notificationsFilter').value;
            
            let filteredNotifications = notifications.filter(notification => {
                // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
                if (searchTerm && !notification.title.toLowerCase().includes(searchTerm) && 
                    !notification.message.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Ø§Ù„ØªØµÙÙŠØ©
                if (filterType === 'active') {
                    return notification.isActive !== false;
                } else if (filterType === 'popup') {
                    return notification.showAsPopup === true;
                } else if (filterType === 'important') {
                    return notification.isImportant === true;
                }
                
                return true;
            });
            
            container.innerHTML = filteredNotifications.map(notification => {
                const createdAt = notification.createdAt?.toDate ? 
                    notification.createdAt.toDate() : new Date(notification.createdAt);
                const expiryDate = notification.expiryDate?.toDate ? 
                    notification.expiryDate.toDate() : new Date(notification.expiryDate);
                
                const isExpired = expiryDate && expiryDate < new Date();
                const isActive = notification.isActive && !isExpired;
                
                return `
                <div class="notification-item-admin ${isActive ? 'active' : 'inactive'}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="text-white mb-1">
                                ${notification.title}
                                ${notification.isImportant ? '<span class="badge bg-danger ms-2">Ù…Ù‡Ù…</span>' : ''}
                                ${notification.showAsPopup ? '<span class="badge bg-info ms-2">Ù…Ù†Ø¨Ø«Ù‚Ø©</span>' : ''}
                                <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                                </span>
                                ${isExpired ? '<span class="badge bg-warning ms-2">Ù…Ù†ØªÙ‡ÙŠ</span>' : ''}
                            </h5>
                            <p class="text-muted mb-2">${notification.message}</p>
                            <div class="notification-meta">
                                <small class="text-info">
                                    <i class="uil uil-calendar-alt"></i> 
                                    ${createdAt.toLocaleString('ar-SA')}
                                </small>
                                ${notification.type ? `
                                    <span class="mx-2">â€¢</span>
                                    <small class="badge bg-info">${notification.type}</small>
                                ` : ''}
                                ${notification.actionUrl ? `
                                    <span class="mx-2">â€¢</span>
                                    <small class="text-primary">
                                        <i class="uil uil-link"></i> Ø±Ø§Ø¨Ø·
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleNotificationStatus('${notification.id}', ${!isActive})">
                                <i class="uil uil-power"></i> ${isActive ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNotification('${notification.id}')">
                                <i class="uil uil-trash-alt"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            if (countElement) countElement.textContent = filteredNotifications.length;
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
        async function sendNotification() {
            try {
                const title = document.getElementById('notificationTitle').value.trim();
                const message = document.getElementById('notificationMessage').value.trim();
                
                if (!title || !message) {
                    showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©', 'warning');
                    return;
                }
                
                if (!db) {
                    await initializeFirebase();
                }
                
                const notificationData = {
                    title: title,
                    message: message,
                    type: document.getElementById('notificationType').value,
                    actionUrl: document.getElementById('notificationActionUrl').value.trim() || null,
                    isActive: document.getElementById('sendImmediately').checked,
                    isRead: false,
                    isImportant: document.getElementById('isImportant').checked,
                    showAsPopup: document.getElementById('showAsPopup').checked,
                    createdAt: new Date(),
                    createdBy: localStorage.getItem('adminEmail') || 'admin'
                };
                
                const expiryDate = document.getElementById('notificationExpiry').value;
                if (expiryDate) {
                    notificationData.expiryDate = new Date(expiryDate);
                }
                
                await db.collection('notifications').add(notificationData);
                
                document.getElementById('notificationForm').reset();
                await loadNotifications();
                
                showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
                showAlert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message, 'error');
            }
        }
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        async function deleteAllNotifications() {
            if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) {
                return;
            }
            
            try {
                const password = prompt('Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© "Ù†Ø¹Ù… Ø£Ø­Ø°Ù":');
                if (password !== 'Ù†Ø¹Ù… Ø£Ø­Ø°Ù') {
                    showAlert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù', 'warning');
                    return;
                }
                
                showAlert('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...', 'info');
                
                if (!db) {
                    await initializeFirebase();
                }
                
                const snapshot = await db.collection('notifications').get();
                
                if (snapshot.empty) {
                    showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø­Ø°ÙÙ‡Ø§', 'info');
                    return;
                }
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`âœ… ØªÙ… Ø­Ø°Ù ${snapshot.size} Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + error.message, 'error');
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        async function deleteExpiredNotifications() {
            try {
                if (!db) {
                    await initializeFirebase();
                }
                
                const snapshot = await db.collection('notifications').get();
                const now = new Date();
                let expiredCount = 0;
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const expiryDate = data.expiryDate?.toDate ? 
                        data.expiryDate.toDate() : new Date(data.expiryDate);
                    
                    if (expiryDate && expiryDate < now) {
                        batch.delete(doc.ref);
                        expiredCount++;
                    }
                });
                
                if (expiredCount === 0) {
                    showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ©', 'info');
                    return;
                }
                
                if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${expiredCount} Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†ØªÙ‡ÙŠØŸ`)) {
                    return;
                }
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`âœ… ØªÙ… Ø­Ø°Ù ${expiredCount} Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†ØªÙ‡ÙŠ`, 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©: ' + error.message, 'error');
            }
        }
        
        // Ø­Ø°Ù Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø­Ø¯
        async function deleteNotification(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ')) return;
            
            try {
                if (!db) {
                    await initializeFirebase();
                }
                
                await db.collection('notifications').doc(id).delete();
                await loadNotifications();
                
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message, 'error');
            }
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        async function toggleNotificationStatus(id, newStatus) {
            try {
                if (!db) {
                    await initializeFirebase();
                }
                
                await db.collection('notifications').doc(id).update({
                    isActive: newStatus,
                    updatedAt: new Date()
                });
                
                await loadNotifications();
                
                showAlert(`ØªÙ… ${newStatus ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±`, 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
                showAlert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message, 'error');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        async function markAllAsRead() {
            try {
                if (!db) {
                    await initializeFirebase();
                }
                
                const snapshot = await db.collection('notifications').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, {
                        isRead: true,
                        readAt: new Date()
                    });
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©', 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + error.message, 'error');
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        async function exportNotifications() {
            try {
                const data = {
                    notifications: notifications,
                    exportedAt: new Date(),
                    total: notifications.length
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notifications-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                showAlert('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + error.message, 'error');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        async function refreshNotifications() {
            await loadNotifications();
            showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'info');
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function testPopup() {
            const title = document.getElementById('notificationTitle').value || 'Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±ÙŠ';
            const message = document.getElementById('notificationMessage').value || 'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©';
            const type = document.getElementById('notificationType').value || 'info';
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ©
            const popup = document.createElement('div');
            popup.id = 'testPopup';
            popup.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                width: 400px;
                max-width: 90%;
                background: linear-gradient(135deg, #151825, #2F2562);
                border: 2px solid #42318F;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                z-index: 10000;
                overflow: hidden;
                animation: slideIn 0.5s ease;
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø­Ø±ÙƒØ©
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(150%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            const icons = {
                'info': 'uil-info-circle',
                'warning': 'uil-exclamation-triangle',
                'success': 'uil-check-circle',
                'update': 'uil-sync',
                'promotion': 'uil-gift'
            };
            
            const icon = icons[type] || 'uil-info-circle';
            
            popup.innerHTML = `
                <div style="padding: 0;">
                    <div style="background: linear-gradient(135deg, #322769, #654FD4); padding: 20px; border-bottom: 2px solid #42318F; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="uil ${icon}" style="font-size: 24px; color: #FF5200;"></i>
                            <h3 style="color: white; margin: 0; font-size: 18px;">${title}</h3>
                        </div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer;">
                            <i class="uil uil-times"></i>
                        </button>
                    </div>
                    <div style="padding: 20px; color: #E1E1E1; line-height: 1.6;">
                        <p style="margin: 0 0 15px 0;">${message}</p>
                    </div>
                    <div style="padding: 15px 20px; background: rgba(0, 0, 0, 0.3); border-top: 1px solid #42318F; display: flex; gap: 10px;">
                        <button style="flex: 1; padding: 10px; background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            <i class="uil uil-check-circle"></i> Ù…ÙˆØ§ÙÙ‚
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 10px; background: linear-gradient(45deg, #6c757d, #495057); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            <i class="uil uil-times-circle"></i> Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 10000);
            
            showAlert('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'info');
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
        function filterNotifications() {
            renderNotifications();
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertDiv.innerHTML = `
                <i class="uil uil-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.admin-container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            await loadNotifications();
            console.log('âœ… ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø­Ù…Ù„Ø© ÙˆØ¬Ø§Ù‡Ø²Ø©');
        });
    </script>
</body>
</html>
