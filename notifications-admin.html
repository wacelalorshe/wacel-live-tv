<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช - ูุณูู ูุงูู ุจุฑู</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/notifications.css">
</head>
<body>
    <div class="admin-container">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 style="color: #E1E1E1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 2.5rem;">
                        <i class="uil uil-bell"></i> ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช
                    </h1>
                    <p class="text-muted">ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู ูุฅุฏุงุฑุชูุง</p>
                </div>

                <!-- Add Notification Form -->
                <div class="card mb-5" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-plus-circle"></i> ุฅุฑุณุงู ุฅุดุนุงุฑ ุฌุฏูุฏ
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="notificationForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุนููุงู ุงูุฅุดุนุงุฑ *</label>
                                        <input type="text" id="notificationTitle" class="form-control" required 
                                               placeholder="ุฃุฏุฎู ุนููุงู ุงูุฅุดุนุงุฑ">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">ููุน ุงูุฅุดุนุงุฑ</label>
                                        <select id="notificationType" class="form-control">
                                            <option value="info">ูุนูููุงุช</option>
                                            <option value="warning">ุชุญุฐูุฑ</option>
                                            <option value="success">ูุฌุงุญ</option>
                                            <option value="update">ุชุญุฏูุซ</option>
                                            <option value="promotion">ุนุฑุถ ุชุฑููุฌู</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุฑุงุจุท ุงูุฅุฌุฑุงุก (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" id="notificationActionUrl" class="form-control" 
                                               placeholder="https://example.com">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ</label>
                                        <input type="date" id="notificationExpiry" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">ูุต ุงูุฅุดุนุงุฑ *</label>
                                <textarea id="notificationMessage" class="form-control" rows="4" required 
                                          placeholder="ุฃุฏุฎู ูุต ุงูุฅุดุนุงุฑ..."></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sendImmediately" checked>
                                <label class="form-check-label">
                                    ุฅุฑุณุงู ููุฑู
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="isImportant">
                                <label class="form-check-label">
                                    ุฅุดุนุงุฑ ููู (ุณูุธูุฑ ุจุงูููู ุงูุฃุญูุฑ)
                                </label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success flex-fill py-3" onclick="sendNotification()">
                                    <i class="uil uil-paper-plane"></i> ุฅุฑุณุงู ุงูุฅุดุนุงุฑ
                                </button>
                                <button type="button" class="btn btn-primary" onclick="scheduleNotification()">
                                    <i class="uil uil-clock"></i> ุฌุฏููุฉ
                                </button>
                                <a href="admin.html" class="btn btn-secondary">
                                    <i class="uil uil-arrow-right"></i> ุงูุนูุฏุฉ ููุฅุฏุงุฑุฉ
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="card mb-4" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-trash-alt"></i> ุฅุฌุฑุงุกุงุช ุฌูุงุนูุฉ
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100 mb-2" onclick="deleteAllNotifications()">
                                    <i class="uil uil-trash-alt"></i> ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุช
                                </button>
                                <small class="text-warning d-block">ุณูุญุฐู ูู ุงูุฅุดุนุงุฑุงุช ููุงุฆูุงู</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100 mb-2" onclick="deleteExpiredNotifications()">
                                    <i class="uil uil-clock"></i> ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ
                                </button>
                                <small class="text-muted">ูุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ ุงูุตูุงุญูุฉ ููุท</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-info w-100 mb-2" onclick="markAllAsRead()">
                                    <i class="uil uil-check-circle"></i> ุชุญุฏูุฏ ุงููู ูููุฑูุก
                                </button>
                                <small class="text-muted">ูุญุฏุฏ ุฌููุน ุงูุฅุดุนุงุฑุงุช ูููุฑูุกุฉ</small>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="deleteOldNotifications()">
                                    <i class="uil uil-calendar-slash"></i> ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ
                                </button>
                                <small class="text-muted">ูุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูุฃูุฏู ูู 30 ููู</small>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="deleteInactiveNotifications()">
                                    <i class="uil uil-power"></i> ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุนุทูุฉ
                                </button>
                                <small class="text-muted">ูุญุฐู ุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงููุดุทุฉ ููุท</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="card" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-list-ui-alt"></i> ุงูุฅุดุนุงุฑุงุช ุงููุฑุณูุฉ
                            <span id="notificationsCount" class="badge bg-primary ms-2">0</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" id="notificationsSearch" class="form-control" 
                                           placeholder="๐ ุจุญุซ ูู ุงูุฅุดุนุงุฑุงุช..." oninput="filterNotifications()">
                                </div>
                                <div class="col-md-4">
                                    <select id="notificationsFilter" class="form-control" onchange="filterNotifications()">
                                        <option value="all">ุฌููุน ุงูุฅุดุนุงุฑุงุช</option>
                                        <option value="active">ูุดุทุฉ ููุท</option>
                                        <option value="expired">ููุชููุฉ</option>
                                        <option value="important">ูููุฉ</option>
                                        <option value="unread">ุบูุฑ ููุฑูุกุฉ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bulk Selection -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllNotifications" 
                                       onchange="toggleSelectAll()">
                                <label class="form-check-label text-white" for="selectAllNotifications">
                                    ุชุญุฏูุฏ ุงููู
                                </label>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger me-2" onclick="deleteSelectedNotifications()" 
                                        id="deleteSelectedBtn" disabled>
                                    <i class="uil uil-trash-alt"></i> ุญุฐู ุงููุญุฏุฏ
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="toggleSelectedStatus()">
                                    <i class="uil uil-power"></i> ุชุจุฏูู ุงูุญุงูุฉ
                                </button>
                            </div>
                        </div>
                        
                        <div id="notificationsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                                </div>
                                <p class="mt-3 text-muted">ุฌุงุฑู ุชุญููู ุงูุฅุดุนุงุฑุงุช...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script>
        let notifications = [];
        let filteredNotifications = [];
        let selectedNotifications = new Set();

        async function loadNotifications() {
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const snapshot = await db.collection('notifications')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                notifications = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                filteredNotifications = [...notifications];
                renderNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุงูุฅุดุนุงุฑุงุช:', error);
                showAlert('ูุดู ุชุญููู ุงูุฅุดุนุงุฑุงุช: ' + error.message, 'error');
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            const countElement = document.getElementById('notificationsCount');
            
            if (!container) return;
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="uil uil-bell-slash" style="font-size: 80px; color: #6c757d;"></i>
                        <h5 class="mt-3 text-muted">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</h5>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            container.innerHTML = filteredNotifications.map(notification => {
                const createdAt = notification.createdAt?.toDate ? 
                    notification.createdAt.toDate() : new Date(notification.createdAt);
                const expiryDate = notification.expiryDate?.toDate ? 
                    notification.expiryDate.toDate() : new Date(notification.expiryDate);
                
                const isExpired = expiryDate && expiryDate < new Date();
                const isActive = notification.isActive && !isExpired;
                const isSelected = selectedNotifications.has(notification.id);
                const isUnread = !notification.isRead;
                
                return `
                <div class="notification-item-admin ${isActive ? 'active' : 'inactive'} ${isSelected ? 'selected' : ''}">
                    <div class="d-flex">
                        <div class="me-3">
                            <input class="form-check-input notification-checkbox" 
                                   type="checkbox" 
                                   value="${notification.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleNotificationSelection('${notification.id}')">
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="text-white mb-1">
                                        ${notification.title}
                                        ${notification.isImportant ? '<span class="badge bg-danger ms-2">ููู</span>' : ''}
                                        <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'} ms-2">
                                            ${isActive ? 'ูุดุท' : 'ุบูุฑ ูุดุท'}
                                        </span>
                                        ${isExpired ? '<span class="badge bg-warning ms-2">ููุชูู</span>' : ''}
                                        ${isUnread ? '<span class="badge bg-info ms-2">ุบูุฑ ููุฑูุก</span>' : ''}
                                    </h5>
                                    <p class="text-muted mb-2">${notification.message}</p>
                                    <div class="notification-meta">
                                        <small class="text-info">
                                            <i class="uil uil-calendar-alt"></i> 
                                            ${createdAt.toLocaleString('ar-SA')}
                                        </small>
                                        ${notification.type ? `
                                            <span class="mx-2">โข</span>
                                            <small class="badge bg-info">${notification.type}</small>
                                        ` : ''}
                                        ${notification.actionUrl ? `
                                            <span class="mx-2">โข</span>
                                            <small class="text-primary">
                                                <i class="uil uil-link"></i> ุฑุงุจุท
                                            </small>
                                        ` : ''}
                                    </div>
                                    ${expiryDate ? `
                                        <small class="text-warning d-block mt-1">
                                            <i class="uil uil-clock"></i> 
                                            ููุชูู ูู: ${expiryDate.toLocaleString('ar-SA')}
                                        </small>
                                    ` : ''}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                                            onclick="toggleNotificationStatus('${notification.id}', ${!isActive})">
                                        <i class="uil uil-power"></i> ${isActive ? 'ุชุนุทูู' : 'ุชูุนูู'}
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteNotification('${notification.id}')">
                                        <i class="uil uil-trash-alt"></i> ุญุฐู
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            if (countElement) countElement.textContent = filteredNotifications.length;
            
            // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุญุฐู ุงููุญุฏุฏ
            updateDeleteSelectedButton();
        }

        // ูุธููุฉ ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุช
        async function deleteAllNotifications() {
            if (!confirm('โ๏ธ ุชุญุฐูุฑ: ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุชุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุญุฐู ูู ุงูุฅุดุนุงุฑุงุช ุจุดูู ููุงุฆู.')) {
                return;
            }
            
            try {
                const password = prompt('ููุชุฃููุฏุ ุฃุฏุฎู ูููุฉ "ุญุฐู" ููุญุฐู ุงููุงูู:');
                if (password !== 'ุญุฐู') {
                    showAlert('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู', 'warning');
                    return;
                }
                
                showAlert('ุฌุงุฑู ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุช...', 'info');
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                // ุฌูุจ ุฌููุน ุงูุฅุดุนุงุฑุงุช
                const snapshot = await db.collection('notifications').get();
                
                if (snapshot.empty) {
                    showAlert('ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ูุญุฐููุง', 'warning');
                    return;
                }
                
                // ุงุณุชุฎุฏุงู batch ูุญุฐู ุฌููุน ุงููุณุชูุฏุงุช
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ
                notifications = [];
                filteredNotifications = [];
                selectedNotifications.clear();
                
                // ุฅุนุงุฏุฉ ุงูุชุญููู
                await loadNotifications();
                
                showAlert(`โ ุชู ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุช:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช: ' + error.message, 'error');
            }
        }

        // ูุธููุฉ ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ
        async function deleteExpiredNotifications() {
            try {
                const count = await getExpiredNotificationsCount();
                
                if (count === 0) {
                    showAlert('ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ููุชููุฉ ุงูุตูุงุญูุฉ', 'info');
                    return;
                }
                
                if (!confirm(`ูู ุชุฑูุฏ ุญุฐู ${count} ุฅุดุนุงุฑ ููุชูู ุงูุตูุงุญูุฉุ`)) {
                    return;
                }
                
                showAlert('ุฌุงุฑู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ...', 'info');
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const snapshot = await db.collection('notifications').get();
                const now = new Date();
                
                const batch = db.batch();
                let deletedCount = 0;
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const expiryDate = data.expiryDate?.toDate ? 
                        data.expiryDate.toDate() : new Date(data.expiryDate);
                    
                    if (expiryDate && expiryDate < now) {
                        batch.delete(doc.ref);
                        deletedCount++;
                    }
                });
                
                if (deletedCount > 0) {
                    await batch.commit();
                    await loadNotifications();
                    showAlert(`โ ุชู ุญุฐู ${deletedCount} ุฅุดุนุงุฑ ููุชูู`, 'success');
                } else {
                    showAlert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฅุดุนุงุฑุงุช ููุชููุฉ', 'info');
                }
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ: ' + error.message, 'error');
            }
        }

        // ูุธููุฉ ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ
        async function deleteOldNotifications() {
            try {
                const days = prompt('ุฃุฏุฎู ุนุฏุฏ ุงูุฃูุงู (ุณูุชู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงูุฃูุฏู ูู ูุฐุง ุงูุนุฏุฏ):', '30');
                if (!days || isNaN(days)) return;
                
                const daysAgo = new Date();
                daysAgo.setDate(daysAgo.getDate() - parseInt(days));
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const snapshot = await db.collection('notifications')
                    .where('createdAt', '<', daysAgo)
                    .get();
                
                if (snapshot.empty) {
                    showAlert(`ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุฃูุฏู ูู ${days} ููู`, 'info');
                    return;
                }
                
                if (!confirm(`ูู ุชุฑูุฏ ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ุฃูุฏู ูู ${days} ูููุ`)) {
                    return;
                }
                
                showAlert(`ุฌุงุฑู ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ูุฏูู...`, 'info');
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`โ ุชู ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ูุฏูู`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ: ' + error.message, 'error');
            }
        }

        // ูุธููุฉ ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุนุทูุฉ
        async function deleteInactiveNotifications() {
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const snapshot = await db.collection('notifications')
                    .where('isActive', '==', false)
                    .get();
                
                if (snapshot.empty) {
                    showAlert('ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ูุนุทูุฉ', 'info');
                    return;
                }
                
                if (!confirm(`ูู ุชุฑูุฏ ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ูุนุทูุ`)) {
                    return;
                }
                
                showAlert(`ุฌุงุฑู ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ูุนุทู...`, 'info');
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`โ ุชู ุญุฐู ${snapshot.size} ุฅุดุนุงุฑ ูุนุทู`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุนุทูุฉ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุนุทูุฉ: ' + error.message, 'error');
            }
        }

        // ูุธููุฉ ุชุญุฏูุฏ ุฌููุน ุงูุฅุดุนุงุฑุงุช ูููุฑูุกุฉ
        async function markAllAsRead() {
            try {
                const unreadCount = notifications.filter(n => !n.isRead).length;
                
                if (unreadCount === 0) {
                    showAlert('ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุบูุฑ ููุฑูุกุฉ', 'info');
                    return;
                }
                
                if (!confirm(`ูู ุชุฑูุฏ ุชุญุฏูุฏ ${unreadCount} ุฅุดุนุงุฑ ูููุฑูุกุ`)) {
                    return;
                }
                
                showAlert('ุฌุงุฑู ุชุญุฏูุซ ุฌููุน ุงูุฅุดุนุงุฑุงุช...', 'info');
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const batch = db.batch();
                notifications.forEach(notification => {
                    if (!notification.isRead) {
                        const ref = db.collection('notifications').doc(notification.id);
                        batch.update(ref, {
                            isRead: true,
                            readAt: new Date()
                        });
                    }
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`โ ุชู ุชุญุฏูุฏ ${unreadCount} ุฅุดุนุงุฑ ูููุฑูุก`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุชุญุฏูุฏ ุฌููุน ุงูุฅุดุนุงุฑุงุช ูููุฑูุกุฉ:', error);
                showAlert('ูุดู ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช: ' + error.message, 'error');
            }
        }

        // ูุธุงุฆู ุงูุฅุฏุงุฑุฉ ุงููุญุฏุฏุฉ
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllNotifications');
            const checkboxes = document.querySelectorAll('.notification-checkbox');
            
            if (selectAll.checked) {
                filteredNotifications.forEach(notif => {
                    selectedNotifications.add(notif.id);
                });
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                selectedNotifications.clear();
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            updateDeleteSelectedButton();
        }

        function toggleNotificationSelection(notificationId) {
            if (selectedNotifications.has(notificationId)) {
                selectedNotifications.delete(notificationId);
            } else {
                selectedNotifications.add(notificationId);
            }
            
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            const button = document.getElementById('deleteSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAllNotifications');
            
            if (selectedNotifications.size > 0) {
                button.disabled = false;
                button.textContent = `ุญุฐู ุงููุญุฏุฏ (${selectedNotifications.size})`;
            } else {
                button.disabled = true;
                button.textContent = 'ุญุฐู ุงููุญุฏุฏ';
            }
            
            // ุชุญุฏูุซ ุญุงูุฉ ุชุญุฏูุฏ ุงููู
            if (filteredNotifications.length > 0 && 
                selectedNotifications.size === filteredNotifications.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedNotifications.size > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        async function deleteSelectedNotifications() {
            const selectedCount = selectedNotifications.size;
            
            if (selectedCount === 0) {
                showAlert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุฅุดุนุงุฑุงุช', 'warning');
                return;
            }
            
            if (!confirm(`ูู ุชุฑูุฏ ุญุฐู ${selectedCount} ุฅุดุนุงุฑ ูุญุฏุฏุ`)) {
                return;
            }
            
            try {
                showAlert(`ุฌุงุฑู ุญุฐู ${selectedCount} ุฅุดุนุงุฑ...`, 'info');
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const batch = db.batch();
                selectedNotifications.forEach(id => {
                    const ref = db.collection('notifications').doc(id);
                    batch.delete(ref);
                });
                
                await batch.commit();
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงููุงุฆูุฉ
                selectedNotifications.clear();
                await loadNotifications();
                
                showAlert(`โ ุชู ุญุฐู ${selectedCount} ุฅุดุนุงุฑ ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุญุฏุฏุฉ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑุงุช ุงููุญุฏุฏุฉ: ' + error.message, 'error');
            }
        }

        async function toggleSelectedStatus() {
            const selectedCount = selectedNotifications.size;
            
            if (selectedCount === 0) {
                showAlert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุฅุดุนุงุฑุงุช', 'warning');
                return;
            }
            
            if (!confirm(`ูู ุชุฑูุฏ ุชุจุฏูู ุญุงูุฉ ${selectedCount} ุฅุดุนุงุฑ ูุญุฏุฏุ`)) {
                return;
            }
            
            try {
                showAlert(`ุฌุงุฑู ุชุญุฏูุซ ${selectedCount} ุฅุดุนุงุฑ...`, 'info');
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const batch = db.batch();
                const notificationsToUpdate = notifications.filter(n => selectedNotifications.has(n.id));
                
                notificationsToUpdate.forEach(notification => {
                    const ref = db.collection('notifications').doc(notification.id);
                    const newStatus = !notification.isActive;
                    
                    batch.update(ref, {
                        isActive: newStatus,
                        updatedAt: new Date()
                    });
                });
                
                await batch.commit();
                await loadNotifications();
                
                showAlert(`โ ุชู ุชุญุฏูุซ ${selectedCount} ุฅุดุนุงุฑ`, 'success');
                
            } catch (error) {
                console.error('โ ูุดู ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช ุงููุญุฏุฏุฉ:', error);
                showAlert('ูุดู ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช ุงููุญุฏุฏุฉ: ' + error.message, 'error');
            }
        }

        // ูุธุงุฆู ูุณุงุนุฏุฉ
        async function getExpiredNotificationsCount() {
            await firebaseUtils.initializeFirebase();
            const db = firebaseUtils.getDB();
            
            const snapshot = await db.collection('notifications').get();
            const now = new Date();
            let count = 0;
            
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const expiryDate = data.expiryDate?.toDate ? 
                    data.expiryDate.toDate() : new Date(data.expiryDate);
                
                if (expiryDate && expiryDate < now) {
                    count++;
                }
            });
            
            return count;
        }

        function filterNotifications() {
            const searchTerm = document.getElementById('notificationsSearch').value.toLowerCase();
            const filterType = document.getElementById('notificationsFilter').value;
            const now = new Date();
            
            filteredNotifications = notifications.filter(notification => {
                // ุงูุจุญุซ ุงููุตู
                const matchesSearch = searchTerm === '' || 
                    (notification.title && notification.title.toLowerCase().includes(searchTerm)) ||
                    (notification.message && notification.message.toLowerCase().includes(searchTerm));
                
                if (!matchesSearch) return false;
                
                // ุงูุชุตููุฉ ุญุณุจ ุงูููุน
                const expiryDate = notification.expiryDate?.toDate ? 
                    notification.expiryDate.toDate() : new Date(notification.expiryDate);
                const isExpired = expiryDate && expiryDate < now;
                
                switch (filterType) {
                    case 'active':
                        return notification.isActive && !isExpired;
                    case 'expired':
                        return isExpired;
                    case 'important':
                        return notification.isImportant;
                    case 'unread':
                        return !notification.isRead;
                    default:
                        return true;
                }
            });
            
            renderNotifications();
        }

        async function deleteNotification(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฅุดุนุงุฑุ')) return;
            
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                await db.collection('notifications').doc(id).delete();
                
                showAlert('ุชู ุญุฐู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ', 'success');
                await loadNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑ: ' + error.message, 'error');
            }
        }

        async function toggleNotificationStatus(id, newStatus) {
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                await db.collection('notifications').doc(id).update({
                    isActive: newStatus,
                    updatedAt: new Date()
                });
                
                showAlert(`ุชู ${newStatus ? 'ุชูุนูู' : 'ุชุนุทูู'} ุงูุฅุดุนุงุฑ`, 'success');
                await loadNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุชุบููุฑ ุญุงูุฉ ุงูุฅุดุนุงุฑ:', error);
                showAlert('ูุดู ุชุบููุฑ ุญุงูุฉ ุงูุฅุดุนุงุฑ: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.admin-container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // ุชุญููู ุงูุฅุดุนุงุฑุงุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>
    
    <style>
        .notification-item-admin {
            background: linear-gradient(135deg, #2F2562, #3A4266);
            border-radius: 10px;
            border: 1px solid #42318F;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .notification-item-admin.active {
            border-left: 4px solid #28a745;
        }
        
        .notification-item-admin.inactive {
            border-left: 4px solid #6c757d;
        }
        
        .notification-item-admin.selected {
            background: linear-gradient(135deg, #322769, #654FD4);
            border: 2px solid #FF5200;
        }
        
        .notification-item-admin:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .notification-checkbox {
            margin-top: 10px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #bd2130);
            transform: translateY(-2px);
        }
    </style>
</body>
</html>
