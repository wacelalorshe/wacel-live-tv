<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช - ูุณูู ูุงูู ุจุฑู</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/notifications.css">
</head>
<body>
    <div class="admin-container">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 style="color: #E1E1E1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 2.5rem;">
                        <i class="uil uil-bell"></i> ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช
                    </h1>
                    <p class="text-muted">ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู ูุฅุฏุงุฑุชูุง</p>
                </div>

                <!-- Add Notification Form -->
                <div class="card mb-5" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-plus-circle"></i> ุฅุฑุณุงู ุฅุดุนุงุฑ ุฌุฏูุฏ
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="notificationForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุนููุงู ุงูุฅุดุนุงุฑ *</label>
                                        <input type="text" id="notificationTitle" class="form-control" required 
                                               placeholder="ุฃุฏุฎู ุนููุงู ุงูุฅุดุนุงุฑ">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">ููุน ุงูุฅุดุนุงุฑ</label>
                                        <select id="notificationType" class="form-control">
                                            <option value="info">ูุนูููุงุช</option>
                                            <option value="warning">ุชุญุฐูุฑ</option>
                                            <option value="success">ูุฌุงุญ</option>
                                            <option value="update">ุชุญุฏูุซ</option>
                                            <option value="promotion">ุนุฑุถ ุชุฑููุฌู</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุฑุงุจุท ุงูุฅุฌุฑุงุก (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" id="notificationActionUrl" class="form-control" 
                                               placeholder="https://example.com">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ</label>
                                        <input type="date" id="notificationExpiry" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">ูุต ุงูุฅุดุนุงุฑ *</label>
                                <textarea id="notificationMessage" class="form-control" rows="4" required 
                                          placeholder="ุฃุฏุฎู ูุต ุงูุฅุดุนุงุฑ..."></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sendImmediately" checked>
                                <label class="form-check-label">
                                    ุฅุฑุณุงู ููุฑู
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="isImportant">
                                <label class="form-check-label">
                                    ุฅุดุนุงุฑ ููู (ุณูุธูุฑ ุจุงูููู ุงูุฃุญูุฑ)
                                </label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success flex-fill py-3" onclick="sendNotification()">
                                    <i class="uil uil-paper-plane"></i> ุฅุฑุณุงู ุงูุฅุดุนุงุฑ
                                </button>
                                <button type="button" class="btn btn-primary" onclick="scheduleNotification()">
                                    <i class="uil uil-clock"></i> ุฌุฏููุฉ
                                </button>
                                <a href="admin.html" class="btn btn-secondary">
                                    <i class="uil uil-arrow-right"></i> ุงูุนูุฏุฉ ููุฅุฏุงุฑุฉ
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="card" style="background: rgba(0,0,0,0.7); border: 1px solid #42318F;">
                    <div class="card-header card-header-custom">
                        <h4 class="mb-0 text-white">
                            <i class="uil uil-list-ui-alt"></i> ุงูุฅุดุนุงุฑุงุช ุงููุฑุณูุฉ
                            <span id="notificationsCount" class="badge bg-primary ms-2">0</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" id="notificationsSearch" class="form-control" 
                                           placeholder="๐ ุจุญุซ ูู ุงูุฅุดุนุงุฑุงุช..." oninput="filterNotifications()">
                                </div>
                                <div class="col-md-4">
                                    <select id="notificationsFilter" class="form-control" onchange="filterNotifications()">
                                        <option value="all">ุฌููุน ุงูุฅุดุนุงุฑุงุช</option>
                                        <option value="active">ูุดุทุฉ ููุท</option>
                                        <option value="expired">ููุชููุฉ</option>
                                        <option value="important">ูููุฉ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="notificationsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                                </div>
                                <p class="mt-3 text-muted">ุฌุงุฑู ุชุญููู ุงูุฅุดุนุงุฑุงุช...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script>
        let notifications = [];
        let filteredNotifications = [];

        async function loadNotifications() {
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                const snapshot = await db.collection('notifications')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                notifications = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                filteredNotifications = [...notifications];
                renderNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุชุญููู ุงูุฅุดุนุงุฑุงุช:', error);
                showAlert('ูุดู ุชุญููู ุงูุฅุดุนุงุฑุงุช: ' + error.message, 'error');
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            const countElement = document.getElementById('notificationsCount');
            
            if (!container) return;
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="uil uil-bell-slash" style="font-size: 80px; color: #6c757d;"></i>
                        <h5 class="mt-3 text-muted">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</h5>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            container.innerHTML = filteredNotifications.map(notification => {
                const createdAt = notification.createdAt?.toDate ? 
                    notification.createdAt.toDate() : new Date(notification.createdAt);
                const expiryDate = notification.expiryDate?.toDate ? 
                    notification.expiryDate.toDate() : new Date(notification.expiryDate);
                
                const isExpired = expiryDate && expiryDate < new Date();
                const isActive = notification.isActive && !isExpired;
                
                return `
                <div class="notification-item-admin ${isActive ? 'active' : 'inactive'}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="text-white mb-1">
                                ${notification.title}
                                ${notification.isImportant ? '<span class="badge bg-danger ms-2">ููู</span>' : ''}
                                <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${isActive ? 'ูุดุท' : 'ุบูุฑ ูุดุท'}
                                </span>
                                ${isExpired ? '<span class="badge bg-warning ms-2">ููุชูู</span>' : ''}
                            </h5>
                            <p class="text-muted mb-2">${notification.message}</p>
                            <div class="notification-meta">
                                <small class="text-info">
                                    <i class="uil uil-calendar-alt"></i> 
                                    ${createdAt.toLocaleString('ar-SA')}
                                </small>
                                ${notification.type ? `
                                    <span class="mx-2">โข</span>
                                    <small class="badge bg-info">${notification.type}</small>
                                ` : ''}
                                ${notification.actionUrl ? `
                                    <span class="mx-2">โข</span>
                                    <small class="text-primary">
                                        <i class="uil uil-link"></i> ุฑุงุจุท
                                    </small>
                                ` : ''}
                            </div>
                            ${expiryDate ? `
                                <small class="text-warning d-block mt-1">
                                    <i class="uil uil-clock"></i> 
                                    ููุชูู ูู: ${expiryDate.toLocaleString('ar-SA')}
                                </small>
                            ` : ''}
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleNotificationStatus('${notification.id}', ${!isActive})">
                                <i class="uil uil-power"></i> ${isActive ? 'ุชุนุทูู' : 'ุชูุนูู'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNotification('${notification.id}')">
                                <i class="uil uil-trash-alt"></i> ุญุฐู
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            if (countElement) countElement.textContent = filteredNotifications.length;
        }

        function filterNotifications() {
            const searchTerm = document.getElementById('notificationsSearch').value.toLowerCase();
            const filterType = document.getElementById('notificationsFilter').value;
            const now = new Date();
            
            filteredNotifications = notifications.filter(notification => {
                // ุงูุจุญุซ ุงููุตู
                const matchesSearch = searchTerm === '' || 
                    notification.title.toLowerCase().includes(searchTerm) ||
                    notification.message.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                // ุงูุชุตููุฉ ุญุณุจ ุงูููุน
                if (filterType === 'active') {
                    const expiryDate = notification.expiryDate?.toDate ? 
                        notification.expiryDate.toDate() : new Date(notification.expiryDate);
                    const isExpired = expiryDate && expiryDate < now;
                    return notification.isActive && !isExpired;
                }
                
                if (filterType === 'expired') {
                    const expiryDate = notification.expiryDate?.toDate ? 
                        notification.expiryDate.toDate() : new Date(notification.expiryDate);
                    return expiryDate && expiryDate < now;
                }
                
                if (filterType === 'important') {
                    return notification.isImportant;
                }
                
                return true;
            });
            
            renderNotifications();
        }

        async function sendNotification() {
            try {
                const notificationData = {
                    title: document.getElementById('notificationTitle').value,
                    message: document.getElementById('notificationMessage').value,
                    type: document.getElementById('notificationType').value,
                    actionUrl: document.getElementById('notificationActionUrl').value || null,
                    isImportant: document.getElementById('isImportant').checked,
                    isActive: document.getElementById('sendImmediately').checked,
                    isRead: false,
                    createdAt: new Date(),
                    createdBy: localStorage.getItem('adminEmail') || 'admin'
                };
                
                const expiryDate = document.getElementById('notificationExpiry').value;
                if (expiryDate) {
                    notificationData.expiryDate = new Date(expiryDate);
                }
                
                if (!notificationData.title || !notificationData.message) {
                    showAlert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ', 'error');
                    return;
                }
                
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                await db.collection('notifications').add(notificationData);
                
                showAlert('ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ', 'success');
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
                document.getElementById('notificationForm').reset();
                
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุฅุดุนุงุฑุงุช
                await loadNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:', error);
                showAlert('ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ: ' + error.message, 'error');
            }
        }

        async function scheduleNotification() {
            const scheduleTime = prompt('ุฃุฏุฎู ููุช ุงูุฌุฏููุฉ (YYYY-MM-DD HH:MM):', 
                new Date(Date.now() + 3600000).toISOString().slice(0, 16));
            
            if (scheduleTime) {
                showAlert('ุชู ุฌุฏููุฉ ุงูุฅุดุนุงุฑ', 'info');
                // ููููู ุฅุถุงูุฉ ููุทู ุงูุฌุฏููุฉ ููุง
            }
        }

        async function toggleNotificationStatus(id, newStatus) {
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                await db.collection('notifications').doc(id).update({
                    isActive: newStatus,
                    updatedAt: new Date()
                });
                
                showAlert(`ุชู ${newStatus ? 'ุชูุนูู' : 'ุชุนุทูู'} ุงูุฅุดุนุงุฑ`, 'success');
                await loadNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุชุบููุฑ ุญุงูุฉ ุงูุฅุดุนุงุฑ:', error);
                showAlert('ูุดู ุชุบููุฑ ุญุงูุฉ ุงูุฅุดุนุงุฑ: ' + error.message, 'error');
            }
        }

        async function deleteNotification(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฅุดุนุงุฑุ')) return;
            
            try {
                await firebaseUtils.initializeFirebase();
                const db = firebaseUtils.getDB();
                
                await db.collection('notifications').doc(id).delete();
                
                showAlert('ุชู ุญุฐู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ', 'success');
                await loadNotifications();
                
            } catch (error) {
                console.error('โ ูุดู ุญุฐู ุงูุฅุดุนุงุฑ:', error);
                showAlert('ูุดู ุญุฐู ุงูุฅุดุนุงุฑ: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.admin-container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // ุชุญููู ุงูุฅุดุนุงุฑุงุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>
    
    <style>
        .notification-item-admin {
            background: linear-gradient(135deg, #2F2562, #3A4266);
            border-radius: 10px;
            border: 1px solid #42318F;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .notification-item-admin.active {
            border-left: 4px solid #28a745;
        }
        
        .notification-item-admin.inactive {
            border-left: 4px solid #6c757d;
        }
        
        .notification-item-admin:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</body>
</html>
